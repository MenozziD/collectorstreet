<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Street - Profilo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav>
        <h1>Collector Street</h1>
        <div class="actions">
            <!-- Primary navigation links -->
            <a href="/home" class="nav-btn">Home</a>
            <a href="/" class="nav-btn">Collezione</a>
            <a href="/profile" class="nav-btn">Profilo</a>
            <button id="logoutBtn">Logout</button>
        </div>
    </nav>
    <section class="profile-container">
        <h2>Il tuo profilo</h2>
        {% if updated %}
            <p class="success-msg">Profilo aggiornato con successo.</p>
        {% endif %}
        <!-- Profilo e link -->
        <div class="profile-card">
            <div class="profile-info">
                {% if user.profile_image_path %}
                    <img class="profile-image" src="{{ url_for('static', filename=user.profile_image_path) }}" alt="Immagine profilo">
                {% else %}
                    <div class="profile-placeholder">Nessuna immagine</div>
                {% endif %}
                <h3>{{ user.nickname or user.username }}</h3>
            </div>
            <div class="profile-links">
                <h4>Link marketplace</h4>
                <ul>
                    {% if user.vinted_link %}
                        <li><a href="{{ user.vinted_link }}" target="_blank">Vinted</a></li>
                    {% endif %}
                    {% if user.cardmarket_link %}
                        <li><a href="{{ user.cardmarket_link }}" target="_blank">Card Market</a></li>
                    {% endif %}
                    {% if user.ebay_link %}
                        <li><a href="{{ user.ebay_link }}" target="_blank">eBay</a></li>
                    {% endif %}
                    {% if user.facebook_link %}
                        <li><a href="{{ user.facebook_link }}" target="_blank">Facebook Marketplace</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
        <hr>
        <!-- Container for edit form and stats side by side -->
        <div class="profile-columns">
            <div class="profile-edit">
                <h3>Modifica profilo</h3>
                <form method="POST" enctype="multipart/form-data" class="profile-form">
                    <label for="nickname">Nickname</label>
                    <input type="text" name="nickname" id="nickname" value="{{ user.nickname or '' }}">
                    <label for="ref_currency">Valuta di riferimento</label>
                    <select name="ref_currency" id="ref_currency">
                        <option value="">Seleziona valuta</option>
                        <option value="EUR" {% if user.ref_currency == 'EUR' %}selected{% endif %}>EUR</option>
                        <option value="USD" {% if user.ref_currency == 'USD' %}selected{% endif %}>USD</option>
                        <option value="JPY" {% if user.ref_currency == 'JPY' %}selected{% endif %}>JPY</option>
                        <option value="GBP" {% if user.ref_currency == 'GBP' %}selected{% endif %}>GBP</option>
                        <option value="CNY" {% if user.ref_currency == 'CNY' %}selected{% endif %}>CNY</option>
                    </select>
                    <label for="profile_image">Immagine profilo</label>
                    <input type="file" name="profile_image" id="profile_image" accept="image/*">
                    <label for="vinted_link">Link Vinted</label>
                    <input type="url" name="vinted_link" id="vinted_link" value="{{ user.vinted_link or '' }}">
                    <label for="cardmarket_link">Link Card Market</label>
                    <input type="url" name="cardmarket_link" id="cardmarket_link" value="{{ user.cardmarket_link or '' }}">
                    <label for="ebay_link">Link eBay</label>
                    <input type="url" name="ebay_link" id="ebay_link" value="{{ user.ebay_link or '' }}">
                    <label for="facebook_link">Link Facebook Marketplace</label>
                    <input type="url" name="facebook_link" id="facebook_link" value="{{ user.facebook_link or '' }}">
                    <button type="submit">Salva modifiche</button>
                </form>
            </div>
            <div class="profile-stats">
                <h3>Statistiche</h3>
                <button type="button" id="updateStatsBtn" class="update-stats-btn">Aggiorna statistiche</button>
                <ul class="stats-list" id="statsList">
                    <li><strong>Totale speso:</strong>
                        {% if stats.currency %}
                            <span id="statTotalSpent">{{ stats.total_spent | round(2) }}</span> {{ stats.currency }}
                        {% else %}
                            <span id="statTotalSpent">-</span>
                        {% endif %}
                    </li>
                    <li><strong>Totale venduto:</strong>
                        {% if stats.currency %}
                            <span id="statTotalSold">{{ stats.total_sold | round(2) }}</span> {{ stats.currency }}
                        {% else %}
                            <span id="statTotalSold">-</span>
                        {% endif %}
                    </li>
                    <li><strong>ROI:</strong>
                        {% if stats.currency and stats.roi is not none %}
                            <span id="statROI">{{ (stats.roi * 100) | round(2) }}</span>%
                        {% else %}
                            <span id="statROI">-</span>
                        {% endif %}
                    </li>
                    <li><strong>Data inizio collezione:</strong> <span id="statStartDate">{{ stats.start_date or '-' }}</span></li>
                    <li><strong>Giorni in collezione:</strong> <span id="statDays">{{ stats.days_in_collection or '-' }}</span></li>
                </ul>
            </div>
        </div>
    </section>
    {% if is_admin %}
    <hr>
    <section class="admin-users">
        <h3>Gestione utenti</h3>
        <table id="usersTable" class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Nickname</th>
                    <th>Valuta rif.</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>
        <h4>Aggiungi/Modifica utente</h4>
        <form id="userForm" class="user-form">
            <input type="hidden" id="editUserId">
            <input type="text" id="newUsername" placeholder="Username" required>
            <input type="password" id="newPassword" placeholder="Password">
            <input type="text" id="newNickname" placeholder="Nickname">
            <select id="newRefCurrency">
                <option value="">Seleziona valuta</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="JPY">JPY</option>
                <option value="GBP">GBP</option>
                <option value="CNY">CNY</option>
            </select>
            <button type="submit">Salva</button>
            <button type="button" id="cancelEditBtn">Annulla</button>
        </form>
    </section>
    {% endif %}
    <script>
        // Logout button handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/logout', { method: 'POST' });
            window.location.href = '/';
        });

        // Admin user management. Only initialize if the current user is admin.
        const isAdmin = {{ 'true' if is_admin else 'false' }};
        if (isAdmin) {
            async function loadUsers() {
                try {
                    const res = await fetch('/api/admin/users');
                    if (res.ok) {
                        const users = await res.json();
                        const tbody = document.getElementById('usersTableBody');
                        tbody.innerHTML = '';
                        users.forEach(user => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.nickname || ''}</td>
                                <td>${user.ref_currency || ''}</td>
                                <td>
                                    <button class="edit-user" data-id="${user.id}">Modifica</button>
                                    <button class="delete-user" data-id="${user.id}">Elimina</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                        // Attach handlers
                        document.querySelectorAll('.edit-user').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const id = btn.dataset.id;
                                const row = btn.closest('tr');
                                const username = row.children[1].textContent;
                                const nickname = row.children[2].textContent;
                                const refCur = row.children[3].textContent;
                                document.getElementById('editUserId').value = id;
                                document.getElementById('newUsername').value = username;
                                document.getElementById('newPassword').value = '';
                                document.getElementById('newNickname').value = nickname;
                                document.getElementById('newRefCurrency').value = refCur;
                            });
                        });
                        document.querySelectorAll('.delete-user').forEach(btn => {
                            btn.addEventListener('click', async () => {
                                const id = btn.dataset.id;
                                if (confirm('Sei sicuro di voler eliminare questo utente?')) {
                                    const resDel = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
                                    if (resDel.ok) {
                                        loadUsers();
                                    } else {
                                        const d = await resDel.json();
                                        alert(d.error || 'Errore durante la cancellazione');
                                    }
                                }
                            });
                        });
                    }
                } catch (err) {
                    console.error(err);
                }
            }
            // Submit handler for user form
            document.getElementById('userForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('editUserId').value;
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newPassword').value.trim();
                const nickname = document.getElementById('newNickname').value.trim();
                const refCurrency = document.getElementById('newRefCurrency').value || null;
                if (!username) {
                    alert('Username obbligatorio');
                    return;
                }
                const payload = { username, nickname, ref_currency: refCurrency };
                // Include password only when set (for new user or if provided in edit)
                if (password) payload.password = password;
                let res;
                if (id) {
                    // Update existing user
                    res = await fetch(`/api/admin/users/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new user (password is required for new user)
                    if (!password) {
                        alert('Password obbligatoria per la creazione di un nuovo utente');
                        return;
                    }
                    res = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, nickname, ref_currency: refCurrency })
                    });
                }
                if (res.ok) {
                    // Clear form and reload list
                    document.getElementById('editUserId').value = '';
                    document.getElementById('userForm').reset();
                    loadUsers();
                } else {
                    const data = await res.json();
                    alert(data.error || 'Errore nel salvataggio utente');
                }
            });
            // Cancel edit button
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                document.getElementById('editUserId').value = '';
                document.getElementById('userForm').reset();
            });
            // Load users on initial page load
            loadUsers();
        }
    </script>
</body>
</html>